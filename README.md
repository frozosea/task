üß≠ –ö–æ–Ω—Ç–µ–∫—Å—Ç
- –ú—ã —É–∂–µ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–ª–∏ Orchestrator (v3). –°–µ–π—á–∞—Å –Ω–∞–º –Ω—É–∂–µ–Ω –º–µ–¥–∏–π–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å: –≥–æ–ª–æ—Å–æ–≤–æ–π WebRTC-—Å–µ—Ä–≤–µ—Ä –Ω–∞ –±–∞–∑–µ LiveKit, –∫–æ—Ç–æ—Ä—ã–π:
- –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–π –º–∏–∫—Ä–æ—Ñ–æ–Ω –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞;
- –ª–æ–∫–∞–ª—å–Ω–æ –¥–µ–ª–∞–µ—Ç VAD (–≥–æ–ª–æ—Å/—Ç–∏—à–∏–Ω–∞) –∏ barge-in (–ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–µ);
- —Å—Ç—Ä–∏–º–∏—Ç –æ—Ç–≤–µ—Ç –±–æ—Ç–∞ –æ–±—Ä–∞—Ç–Ω–æ (8 –∫–ì—Ü PCM -> Opus);
- –æ–±—â–∞–µ—Ç—Å—è —Å –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º (–ø–æ–∫–∞ –º–æ–∫-–∫–ª–∞—Å—Å) —á–µ—Ä–µ–∑ –ø—Ä–æ—Å—Ç–æ–π Python-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: –æ—Ç–¥–∞—ë—Ç partial/final —Ç–µ–∫—Å—Ç—ã –∏ –∏–≤–µ–Ω—Ç—ã, –ø–æ–ª—É—á–∞–µ—Ç –∞—É–¥–∏–æ-–æ—Ç–≤–µ—Ç/–∫–æ–º–∞–Ω–¥—ã.
- –¶–µ–ª—å –¥–µ–º–æ: –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏, —á—ë—Ç–∫–∞—è —Ä–∞–±–æ—Ç–∞ VAD/barge-in, –ª–æ–≥-–º–µ—Ç—Ä–∏–∫–∏. –ì–ª—É–±–æ–∫–∏–µ —Ç–µ—Å—Ç—ã –Ω–µ –Ω—É–∂–Ω—ã.

‚∏ª

üéØ –ß—Ç–æ —Å—Ç—Ä–æ–∏–º (–∫—Ä–∞—Ç–∫–æ)
	1.	LiveKit Server –ª–æ–∫–∞–ª—å–Ω–æ (Docker).
	2.	Python-—Å–µ—Ä–≤–∏—Å webapi/voice_node:
- –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ LiveKit –∫–æ–º–Ω–∞—Ç–µ –∫–∞–∫ ¬´–±–æ—Ç¬ª (publisher+subscriber).
- –ó–∞–±–∏—Ä–∞–µ—Ç –∏–∑ –∫–æ–º–Ω–∞—Ç—ã –≤—Ö–æ–¥—è—â–µ–µ –∞—É–¥–∏–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- –†–µ—Å–µ–º–ø–ª–∏—Ç –≤ PCM 8 –∫–ì—Ü mono, —Ä–µ–∂–µ—Ç –Ω–∞ —Ñ—Ä–µ–π–º—ã 20 –º—Å.
- –ì–æ–Ω—è–µ—Ç —á–µ—Ä–µ–∑ VAD Sierra (–µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è ‚Äî drop-in —á–µ—Ä–µ–∑ WebRTC-VAD –∫–∞–∫ fallback).
- –ü–æ VAD-–∏–≤–µ–Ω—Ç–∞–º:
- speech_started ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ñ—Ä–∞–∑—ã;
- speech_ended ‚Äî –≤—ã–¥–∞—ë–º final –≤ –º–æ–∫-–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä;
- –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –æ—Ç–¥–∞—á–µ –±–æ—Ç–∞, –∏ –µ—Å–ª–∏ –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ‚Äî —à–ª—ë–º barge_in_detected –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –æ—Ç–¥–∞—á—É.
- –û—Ç –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –±–µ—Ä—ë–º –∞—É–¥–∏–æ-–æ—Ç–≤–µ—Ç (–¥–ª—è –¥–µ–º–æ ‚Äî —ç—Ö–æ) –∏ –ø—É–±–ª–∏–∫—É–µ–º –µ–≥–æ –≤ –∫–æ–º–Ω–∞—Ç—É –∫–∞–∫ audio track (Opus), –≤–Ω–µ—à–Ω–µ —ç—Ç–æ –∑–≤—É—á–∏—Ç –∫–∞–∫ ¬´–±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç¬ª.
- –í–µ–¥—ë–º JSON-–ª–æ–≥–∏ –∑–∞–¥–µ—Ä–∂–µ–∫: t1..t6 (—Å–º. –Ω–∏–∂–µ).
	3.	–ü—Ä–æ—Å—Ç–æ–π –∫–ª–∏–µ–Ω—Ç (web-—Å—Ç—Ä–∞–Ω–∏—á–∫–∞ –Ω–∞ LiveKit CDN): –Ω–∞–∂–∞–ª Join ‚Üí –≥–æ–≤–æ—Ä–∏—à—å ‚Üí –≤–∏–¥–∏—à—å/—Å–ª—ã—à–∏—à—å –æ—Ç–≤–µ—Ç ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—à—å barge-in.

‚∏ª

üß± –î–µ—Ä–µ–≤–æ –ø–∞–ø–æ–∫ (–º–∏–Ω–∏–º—É–º)

project_root/
‚îú‚îÄ .env.example
‚îú‚îÄ docker-compose.livekit.yml
‚îú‚îÄ webapi/
‚îÇ  ‚îú‚îÄ __init__.py
‚îÇ  ‚îú‚îÄ voice_node/
‚îÇ  ‚îÇ  ‚îú‚îÄ __init__.py
‚îÇ  ‚îÇ  ‚îú‚îÄ config.py               # env + –∫–æ–Ω—Ñ–∏–≥–∏ –∞—É–¥–∏–æ/–∫–æ–º–Ω–∞—Ç/–ª–æ–≥–æ–≤
‚îÇ  ‚îÇ  ‚îú‚îÄ livekit_runner.py       # —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å LiveKit, join/subscribe/publish
‚îÇ  ‚îÇ  ‚îú‚îÄ audio_io.py             # —Ä–µ—Å–µ–º–ø–ª 48k->8k –∏ –æ–±—Ä–∞—Ç–Ω–æ, —Ñ—Ä–µ–π–º–∏–Ω–≥, PCM utils
‚îÇ  ‚îÇ  ‚îú‚îÄ vad.py                  # –æ–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ Sierra VAD (+fallback WebRTC-VAD)
‚îÇ  ‚îÇ  ‚îú‚îÄ orchestrator_mock.py    # –º–æ–∫-–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä (—ç–∫–æ, –∫–æ–º–∞–Ω–¥—ã, —Å–æ–±—ã—Ç–∏—è)
‚îÇ  ‚îÇ  ‚îú‚îÄ pipeline.py             # –≥–ª–∞–≤–Ω–∞—è –ø–µ—Ç–ª—è: –ø—Ä–∏—ë–º ‚Üí VAD ‚Üí —Å–æ–±—ã—Ç–∏—è ‚Üí –æ—Ç–≤–µ—Ç
‚îÇ  ‚îÇ  ‚îú‚îÄ metrics.py              # –º–µ—Ç–∫–∏ t1..t6 + JSON-–ª–æ–≥
‚îÇ  ‚îÇ  ‚îî‚îÄ main.py                 # entrypoint (CLI: run-voice-node)
‚îÇ  ‚îî‚îÄ static/
‚îÇ     ‚îî‚îÄ client.html             # super-–ø—Ä–æ—Å—Ç–æ–π –≤–µ–±-–∫–ª–∏–µ–Ω—Ç (Join/Leave)
‚îî‚îÄ scripts/
   ‚îî‚îÄ gen_token.py               # jwt –¥–ª—è LiveKit (–ª–æ–∫–∞–ª—å–Ω–æ, dev)


‚∏ª

üî© –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- Python: 3.10+ (–æ–∫, —É –Ω–∞—Å 3.13, –Ω–æ –º–æ–∂–Ω–æ 3.10).
- Pip –ø–∞–∫–µ—Ç—ã:
- livekit-agents –∏/–∏–ª–∏ livekit-rtc (–∫–ª–∏–µ–Ω—Ç –∫ LiveKit –∏–∑ Python)
- numpy, soundfile (libsndfile), pysoxr (–∏–ª–∏ resampy)
- webrtcvad (fallback VAD). –¢–∞–º –º–Ω–æ–≥–æ –ø—Ä–æ–±–ª–µ–º —Å –¥–æ–ø –ø–∞–∫–µ—Ç–∞–º–∏, —Å–æ–≤–µ—Ç—É—é –ø–æ—á–∏—Ç–∞—Ç—å –¥–æ–∫—É –Ω–∞ https://github.com/livekit/python-sdks 
- Sierra VAD: –µ—Å–ª–∏ –µ—Å—Ç—å pip-–ø–∞–∫–µ—Ç ‚Äî —Å—Ç–∞–≤–∏–º; –µ—Å–ª–∏ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É/–º–æ–¥—É–ª—å. –í –ª—é–±–æ–º —Å–ª—É—á–∞–µ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ –Ω–∞—à vad.py —Å –µ–¥–∏–Ω—ã–º API.
- uvicorn, fastapi (–µ—Å–ª–∏ —Ä–µ—à–∏–º –æ—Ç–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—Å–∫—É—é —Å—Ç—Ä–∞–Ω–∏—á–∫—É –∏–∑ Python ‚Äî —É–¥–æ–±–Ω–æ)
- python-dotenv, loguru (–∏–ª–∏ structlog)
- LiveKit Server (docker –æ–±—Ä–∞–∑), LiveKit CDN –¥–ª—è client.html.

.env.example (–∑–∞–ø–æ–ª–Ω–∏—Ç—å –∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –≤ .env):

# LiveKit
LIVEKIT_URL=ws://localhost:7880
LIVEKIT_API_KEY=devkey
LIVEKIT_API_SECRET=secret

# Room/Identity
LK_ROOM=demo
LK_BOT_IDENTITY=ingobot
LK_USER_PUBLISH_AUDIO=true

# Audio
AUDIO_TARGET_RATE=8000
AUDIO_FRAME_MS=20
AUDIO_CHANNELS=1

# Logging
LOG_FILE=voice_node.log
METRICS_FILE=metrics.jsonl


‚∏ª

üê≥ LiveKit –ª–æ–∫–∞–ª—å–Ω–æ

docker-compose.livekit.yml (—É–∂–µ –≥–æ—Ç–æ–≤), –¥–µ–π—Å—Ç–≤–∏—è:
	1.	docker compose -f docker-compose.livekit.yml up -d
	2.	LiveKit UI: http://localhost:7880 (–µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω) –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º URL –∏–∑ .env.
	3.	–¢–æ–∫–µ–Ω—ã –¥–ª—è –∫–æ–º–Ω–∞—Ç—ã ‚Äî –≥–µ–Ω–µ—Ä–∏–º scripts/gen_token.py (JWT –¥–ª—è client.html –∏ –¥–ª—è voice_node).

‚∏ª

üß† –ê—É–¥–∏–æ/–ø–æ—Ç–æ–∫–∏: –∫–∞–∫ –¥–µ–ª–∞–µ–º
- –í—Ö–æ–¥ –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞ –≤ LiveKit –∏–¥—ë—Ç –∫–∞–∫ Opus 48 –∫–ì—Ü.
- –ú—ã –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Python –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Ç—Ä–µ–∫, –¥–µ–∫–æ–¥–∏–º –≤ float32 48 –∫–ì—Ü,
—Ä–µ—Å–µ–º–ø–ª–∏–º ‚Üí PCM int16 8 –∫–ì—Ü, —Ä–µ–∂–µ–º –ø–æ 20 –º—Å (160 —Å—ç–º–ø–ª–æ–≤), mono.
- –≠—Ç–æ—Ç 8–∫ –ø–æ—Ç–æ–∫ –∏–¥—ë—Ç:
- –≤ VAD –¥–ª—è —Å–æ–±—ã—Ç–∏–π speech_started/speech_ended;
- (–ø–æ –∂–µ–ª–∞–Ω–∏—é) –≤ STT (–¥–∞–ª—å—à–µ –ø–æ–¥–∫–ª—é—á–∏–º –≤–∞—à stt_yandex).
- –û—Ç–≤–µ—Ç –±–æ—Ç–∞: –ø–æ–ª—É—á–∞–µ–º PCM 8 –∫–ì—Ü int16 (–æ—Ç –º–æ–∫-–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞), –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ä–µ—Å–µ–º–ø–ª–∏–º –≤ 48 –∫–ì—Ü –∏ –ø—É–±–ª–∏–∫—É–µ–º –∫–∞–∫ LiveKit audio track (Opus).
–î–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ ¬´8–∫ –≤—Å—ë¬ª ‚Äî –Ω–∞—à –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–∞–π–ø–ª–∞–π–Ω 8 –∫–ì—Ü. –£ –∫–ª–∏–µ–Ω—Ç–∞ Opus ‚Üí LiveKit —Å–∞–º –ø–æ–¥—Å—Ç—Ä–æ–∏—Ç.

‚∏ª

üì° –ü—Ä–æ—Ç–æ–∫–æ–ª —Å–æ–±—ã—Ç–∏–π –≤–Ω—É—Ç—Ä–∏ —É–∑–ª–∞

–°–µ—Ä–≤–∏—Å —Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω, –Ω–æ –æ–±—â–∞–µ—Ç—Å—è —Å (–º–æ–∫-)–û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º:

–í —Å—Ç–æ—Ä–æ–Ω—É –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞:
- on_speech_started(trace_id, ts_monotonic)
- on_partial_audio(trace_id, pcm8k_chunk) (–æ—Å—Ç–∞–≤–∏–º –∫–∞–∫ –∑–∞–¥–µ–ª ‚Äî —Å–µ–π—á–∞—Å –º–æ–∂–Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å)
- on_speech_ended(trace_id, utterance_pcm8k, t_first_byte, t_last_byte) ‚Üí –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –≤–µ—Ä–Ω—ë—Ç –∞—É–¥–∏–æ-–æ—Ç–≤–µ—Ç
- on_barge_in_detected(trace_id) (–∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–±–∏–≤–∞–µ—Ç –≤–æ –≤—Ä–µ–º—è BOT_TURN)

–û—Ç –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞:
- get_audio_reply(trace_id, user_pcm8k) ‚Üí pcm8k_stream (–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —á–∞–Ω–∫–æ–≤)
- stop_playback(trace_id) (–∫–æ–≥–¥–∞ –ø—Ä–∏—à—ë–ª barge-in)
- play_filler(trace_id, key) (–Ω–∞ –±—É–¥—É—â–µ–µ, —Å–µ–π—á–∞—Å –º–æ–∂–Ω–æ no-op)

‚∏ª

üß™ VAD –∏ barge-in (–ø—Ä–∞–≤–∏–ª–∞)
- VAD –æ–∫–Ω–æ: 20 –º—Å —Ñ—Ä–µ–π–º—ã, –∞–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ —Å–∫–æ–ª—å–∑—è—â–µ–º—É –±—É—Ñ–µ—Ä—É 200‚Äì300 –º—Å.
- speech_started: ‚â• N —Ñ—Ä–µ–π–º–æ–≤ ¬´voice¬ª –ø–æ–¥—Ä—è–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 6‚Äì8 —Ñ—Ä–µ–π–º–æ–≤).
- speech_ended: ‚â• M —Ñ—Ä–µ–π–º–æ–≤ ¬´non-voice¬ª –ø–æ–¥—Ä—è–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 8‚Äì10 —Ñ—Ä–µ–π–º–æ–≤).
- barge-in:
- –µ—Å–ª–∏ –∏–¥—ë—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –±–æ—Ç–∞ –∏ VAD —É–ª–æ–≤–∏–ª speech_started –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí
	1.	–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤—ã–∑–≤–∞—Ç—å orchestrator_mock.stop_playback(trace_id)
	2.	–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é —Ç–µ–∫—É—â–µ–≥–æ –∞—É–¥–∏–æ-—Ç—Ä–µ–∫–∞ –±–æ—Ç–∞ (–∏–ª–∏ –ø—Ä–µ—Ä–≤–∞—Ç—å –±—É—Ñ–µ—Ä)
	3.	–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç—Ä–∏–∫—É barge_in: true –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å–ª—É—à–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–í—Å–µ –ø–æ—Ä–æ–≥–∏ –¥–µ—Ä–∂–∏–º –≤ config.py –∏ –≤—ã—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–æ—Å—Ç—ã–º–∏ —á–∏—Å–ª–∞–º–∏.

‚∏ª

‚è±Ô∏è –ú–µ—Ç—Ä–∏–∫–∏/–ª–æ–≥–∏ (–º–∏–Ω–∏–º—É–º, JSON-—Å—Ç—Ä–æ–∫–∞ –Ω–∞ —Å—Ç—Ä–æ–∫—É)

–§–∞–π–ª: METRICS_FILE (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é metrics.jsonl)
- trace_id, turn_index
- t1_first_user_audio ‚Äî –ø—Ä–∏—Ö–æ–¥ –ø–µ—Ä–≤–æ–≥–æ –±–∞–π—Ç–∞ –∑–∞–ø–∏—Å–∏ —Ñ—Ä–∞–∑—ã (–ø–æ—Å–ª–µ —Ç–∏—à–∏–Ω—ã)
- t2_speech_ended ‚Äî –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω –∫–æ–Ω–µ—Ü —Ä–µ—á–∏ (–¥–æ STT)
- t3_logic_start ‚Äî –º–æ–º–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä (–º–æ–∫)
- t5_tts_first_chunk ‚Äî –ø–æ–ª—É—á–∏–ª–∏ –ø–µ—Ä–≤—ã–π –∞—É–¥–∏–æ-—á–∞–Ω–∫ –æ—Ç–≤–µ—Ç–∞
- t6_first_bot_audio ‚Äî –æ–ø—É–±–ª–∏–∫–æ–≤–∞–ª–∏ –ø–µ—Ä–≤—ã–π —á–∞–Ω–∫ –≤ LiveKit
- barge_in ‚Äî true/false, playback_cancelled ‚Äî true/false
- latency_user_to_first_bot_chunk_ms (t6 - t1)
- vad_speech_ms ‚Äî –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ñ—Ä–∞–∑—ã –ø–æ VAD

–õ–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–∞ (LOG_FILE): –æ–±—ã—á–Ω—ã–π JSON-–ª–æ–≥ —Å —É—Ä–æ–≤–Ω–µ–º, —Å–æ–æ–±—â–µ–Ω–∏–µ–º, –ø–æ–ª—è–º–∏ trace_id, room, –∏ —Ç. –¥.

‚∏ª

üß™ –ü—Ä–æ—Å—Ç–æ–π –∫–ª–∏–µ–Ω—Ç (–º–∏–Ω–∏–º—É–º)

webapi/static/client.html:
- –ü–æ–ª–µ Token, Room, –∫–Ω–æ–ø–∫–∞ Join / Leave.
- –ü—Ä–∏ Join:
- –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ LiveKit (—á–µ—Ä–µ–∑ CDN —Å–∫—Ä–∏–ø—Ç),
- –ø—É–±–ª–∏–∫—É–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω,
- –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∞—É–¥–∏–æ-—Ç—Ä–µ–∫ –±–æ—Ç–∞.
- –ù–∞ —ç–∫—Ä–∞–Ω–µ –º–æ–∂–Ω–æ –≤—ã–≤–æ–¥–∏—Ç—å:
- –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä VAD (–ø–æ–ª—É—á–∏–º –∏–∑ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö toast —á–µ—Ä–µ–∑ websockets? –í –¥–µ–º–æ –º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å),
- —Å—Ç–∞—Ç—É—Å ¬´barge-in —Å–ª—É—á–∏–ª—Å—è¬ª (–æ–ø—Ü. —á–µ—Ä–µ–∑ –ª–æ–≥–∏).

(–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –æ—Ç–¥–∞–π —Å—Ç–∞—Ç–∏–∫—É —á–µ—Ä–µ–∑ FastAPI –≤ main.py ‚Äî 10 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞.)

‚∏ª

üß™ –ú–æ–∫-–û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä (–º–∏–Ω–∏–º—É–º, –≥–æ—Ç–æ–≤ –∫ –≤—Å—Ç–∞–≤–∫–µ)

–≠—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–¥, —á—Ç–æ–±—ã –Ω–µ –≥–æ–Ω—è—Ç—å —Ç–µ–±—è –ø–∏—Å–∞—Ç—å —Å–∞–º. –û–Ω –ø—Ä–æ—Å—Ç–æ–π –∏ –Ω—É–∂–µ–Ω –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –¥–µ–º–æ.

# webapi/voice_node/orchestrator_mock.py
import asyncio
import time
from typing import AsyncIterator, Optional

class OrchestratorMock:
    """
    –û—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ–π –º–æ–∫:
    - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç "—ç—Ö–æ" —Ç–µ–∫—Å—Ç–∞/–∞—É–¥–∏–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ —Å–∏–Ω—Ç–µ—Ç–∏–∫—É: sine-–±–∏–ø + –ø–∞—É–∑—ã,
      –ª–∏–±–æ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞—Ä–∞–Ω–µ–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π PCM 8k (–µ—Å–ª–∏ –ø–æ–¥–ª–æ–∂–∏–º).
    - –£–º–µ–µ—Ç "–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å" —Ç–µ–∫—É—â–∏–π —Å—Ç—Ä–∏–º –ø–æ barge-in (—á–µ—Ä–µ–∑ —Ñ–ª–∞–≥).
    - –õ–æ–≥–∏—Ä—É–µ—Ç t4/t5 —Å–æ–±—ã—Ç–∏—è —á–µ—Ä–µ–∑ –∫–æ–ª–±—ç–∫–∏ (–≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç –∏—Ö –Ω–∞—Ä—É–∂—É).
    """
    def __init__(self):
        self._stop_flag = False
        self.on_tts_first_chunk = None  # optional: callable(trace_id, ts)
        self.on_llm_request_done = None # optional: callable(trace_id, ts)

    def stop_playback(self, trace_id: str):
        self._stop_flag = True

    async def get_audio_reply(self, trace_id: str, user_pcm8k: bytes) -> AsyncIterator[bytes]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 8–∫ PCM –º–æ–Ω–æ—Ç–æ–Ω—ã. –î–ª—è –¥–µ–º–æ: —Å–Ω–∞—á–∞–ª–∞ –∫–æ—Ä–æ—Ç–∫–∏–π —Å–∏–≥–Ω–∞–ª, –ø–æ—Ç–æ–º "—ç—Ö–æ".
        –ß–∞–Ω–∫ ~20–º—Å = 160 —Å—ç–º–ø–ª–æ–≤ = 320 –±–∞–π—Ç (s16le mono).
        """
        # –∏–º–∏—Ç–∞—Ü–∏—è "LLM –≥–æ—Ç–æ–≤–∏—Ç –æ—Ç–≤–µ—Ç"
        await asyncio.sleep(0.12)
        if self.on_llm_request_done:
            self.on_llm_request_done(trace_id, time.monotonic())

        frame = b"\x00\x00" * 160  # —Ç–∏—à–∏–Ω–∞ 20–º—Å
        beep = (b"\x7f\x00" * 80) + (b"\x00\x00" * 80)  # –ø—Ä–æ—Å—Ç–æ–π "–±–∏–ø" ~20–º—Å

        # –ø–µ—Ä–≤—ã–π "–±–∏–ø" –∫–∞–∫ –ø—Ä–∏–∑–Ω–∞–∫ tts first chunk
        if self.on_tts_first_chunk:
            self.on_tts_first_chunk(trace_id, time.monotonic())
        yield beep

        # –∑–∞—Ç–µ–º 40 —Ñ—Ä–µ–π–º–æ–≤ "—Ç–∏—Ö–æ–π —Ä–µ—á–∏"
        for _ in range(40):
            if self._stop_flag:
                self._stop_flag = False
                return
            await asyncio.sleep(0.02)
            yield frame

–í —Ä–µ–∞–ª—å–Ω–æ–π —Å–≤—è–∑–∫–µ —Å—é–¥–∞ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è TTSManager.start_llm_stream() –∏ –Ω–∞—Å—Ç–æ—è—â–∏–π –æ—Ç–≤–µ—Ç. –î–ª—è –¥–µ–º–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.

‚∏ª

üß© –ü–æ–≤–µ–¥–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ (end-to-end)
	1.	voice_node –∑–∞—Ö–æ–¥–∏—Ç –≤ –∫–æ–º–Ω–∞—Ç—É LK_ROOM –∫–∞–∫ LK_BOT_IDENTITY, –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –ø–µ—Ä–≤—ã–π –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
	2.	–ò–¥—ë—Ç –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:
- —Ä–µ—Å–µ–º–ø–ª –≤ 8 –∫–ì—Ü, —Ñ—Ä–µ–π–º–∏–Ω–≥ –ø–æ 20 –º—Å, VAD;
- speech_started ‚Üí –æ—Ç–º–µ—Ç–∫–∞ t1;
- speech_ended ‚Üí —Å–æ–±–∏—Ä–∞–µ–º —Ñ—Ä–∞–∑—É (–±—É—Ñ–µ—Ä PCM 8k), —Ñ–∏–∫—Å–∏—Ä—É–µ–º t2, –≤—ã–∑—ã–≤–∞–µ–º orchestrator_mock.get_audio_reply(), —Ñ–∏–∫—Å–∏—Ä—É–µ–º t3 (–≤ –º–æ–º–µ–Ω—Ç –≤—ã–∑–æ–≤–∞) –∏ t5 (–∫–æ–ª–±—ç–∫ –ø–µ—Ä–≤–æ–≥–æ —á–∞–Ω–∫–∞),
- –ø—É–±–ª–∏–∫—É–µ–º –∞—É–¥–∏–æ –∫–∞–∫ LiveKit track ‚Üí t6;
	3.	–ï—Å–ª–∏ –≤–æ –≤—Ä–µ–º—è –æ—Ç–¥–∞—á–∏ –±–æ—Ç–∞ VAD –ª–æ–≤–∏—Ç –≥–æ–ª–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí barge-in:
- –≤—ã–∑—ã–≤–∞—Ç—å orchestrator_mock.stop_playback(),
- –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é —Ç—Ä–µ–∫–∞,
- –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å barge_in=true, playback_cancelled=true,
- –Ω–∞—á–∏–Ω–∞—Ç—å —Å–ª—É—à–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

‚∏ª

‚öôÔ∏è –ö–∞–∫ –∑–∞–ø—É—Å–∫–∞—Ç—å (–ª–æ–∫–∞–ª—å–Ω–æ)
	1.	LiveKit:

docker compose -f docker-compose.livekit.yml up -d


	2.	–¢–æ–∫–µ–Ω –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ –∏ –±–æ—Ç–∞:

python scripts/gen_token.py --room demo --identity ingobot --api-key devkey --api-secret secret
# –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –≤–æ–∑—å–º–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–π identity, –Ω–∞–ø—Ä–∏–º–µ—Ä "me"


	3.	–°–µ—Ä–≤–∏—Å:

pip install -U livekit-agents livekit-rtc numpy soundfile pysoxr webrtcvad loguru python-dotenv fastapi uvicorn
export $(cat .env | xargs)  # –∏–ª–∏ –ø–æ–ª–æ–∂–∏ .env —Ä—è–¥–æ–º
python -m webapi.voice_node.main --room demo --identity ingobot


	4.	–ö–ª–∏–µ–Ω—Ç:
- –æ—Ç–∫—Ä–æ–π webapi/static/client.html –≤ –±—Ä–∞—É–∑–µ—Ä–µ;
- –≤—Å—Ç–∞–≤—å —Ç–æ–∫–µ–Ω, –Ω–∞–∂–º–∏ Join;
- –≥–æ–≤–æ—Ä–∏ –≤ –º–∏–∫—Ä–æ—Ñ–æ–Ω ‚Üí —É—Å–ª—ã—à—å —ç—Ö–æ –±–æ—Ç–∞;
- –Ω–∞—á–Ω–∏ –≥–æ–≤–æ—Ä–∏—Ç—å, –ø–æ–∫–∞ –±–æ—Ç ¬´–≥–æ–≤–æ—Ä–∏—Ç¬ª ‚Üí –¥–æ–ª–∂–µ–Ω —Å—Ä–∞–±–æ—Ç–∞—Ç—å barge-in (–±–æ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∑–∞—Ç–∫–Ω—ë—Ç—Å—è).

‚∏ª

üóÇÔ∏è –ó–∞–¥–∞—á–∏ (–º–∞–ª—ã–µ, –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ)

–ó–∞–¥–∞—á–∞ 1. –ò–Ω—Ñ—Ä–∞ –∏ –∫–æ–Ω—Ñ–∏–≥–∏

–¶–µ–ª—å: –ø–æ–¥–Ω—è—Ç—å LiveKit –ª–æ–∫–∞–ª—å–Ω–æ, —Ç–æ–∫–µ–Ω—ã, .env, –∑–∞–≥–æ—Ç–æ–≤–∫–∏ —Ñ–∞–π–ª–æ–≤.
- –î–æ–±–∞–≤–∏—Ç—å docker-compose.livekit.yml, .env.example, scripts/gen_token.py.
- –ù–∞–ø–æ–ª–Ω–∏—Ç—å webapi/voice_node/config.py (—á—Ç–µ–Ω–∏–µ env, –ø–æ—Ä–æ–≥–∏ VAD, —Ä–∞–∑–º–µ—Ä—ã —Ñ—Ä–µ–π–º–æ–≤).
- –î–æ–±–∞–≤–∏—Ç—å webapi/static/client.html (–∫–Ω–æ–ø–∫–∞ Join/Leave, –≤–≤–æ–¥ —Ç–æ–∫–µ–Ω–∞, –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞, –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ remote track).
- –ü—Ä–æ–≤–µ—Ä–∫–∞: –∫–ª–∏–µ–Ω—Ç –∑–∞—Ö–æ–¥–∏—Ç –≤ –∫–æ–º–Ω–∞—Ç—É, –≤–∏–¥–∏—Ç —Å–µ–±—è –≤ —Å–ø–∏—Å–∫–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.

–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: –º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä.

‚∏ª

–ó–∞–¥–∞—á–∞ 2. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Python –∫ LiveKit

–¶–µ–ª—å: –±–æ—Ç –≤ –∫–æ–º–Ω–∞—Ç–µ, –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –≤—Ö–æ–¥—è—â–∏–π –∞—É–¥–∏–æ-—Ç—Ä–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø—É–±–ª–∏–∫—É–µ—Ç —Å–≤–æ–π —Ç—Ä–µ–∫.
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å livekit_runner.py: join room, subscribe –Ω–∞ –ø–µ—Ä–≤—ã–π audio track, publish audio track ¬´bot_out¬ª.
- –ü—Ä–æ—Ç–æ–∫–æ–ª –∫–æ–ª–±—ç–∫–æ–≤: on_track_subscribed(raw frames 48k), publisher.sink(generator of 48k frames).
- –í main.py ‚Äî CLI, graceful shutdown, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ.

–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: –±–æ—Ç –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∏—Å—Ö–æ–¥—è—â–µ–µ –∞—É–¥–∏–æ –∏ —É–º–µ–µ—Ç –æ—Ç–¥–∞–≤–∞—Ç—å —Å–≤–æ–π —Å–∏–≥–Ω–∞–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–∏–Ω—É—Å).

‚∏ª

–ó–∞–¥–∞—á–∞ 3. –ê—É–¥–∏–æ-–ø–∞–π–ø–ª–∞–π–Ω (—Ä–µ—Å–µ–º–ø–ª –∏ —Ñ—Ä–µ–π–º–∏–Ω–≥)

–¶–µ–ª—å: –≤–Ω—É—Ç—Ä–∏ —É–∑–ª–∞ –≤—Å—ë –≥–æ–Ω—è–µ–º –≤ PCM 8 –∫–ì—Ü mono, 20 –º—Å.
- audio_io.py:
- resample_48k_to_8k(float32->int16), resample_8k_to_48k(int16->float32)
- frame_8k_20ms(pcm8k_bytes) -> Iterable[bytes], join_frames(frames)->bytes.
- –ú–∏–∫—Ä–æ—Ç–µ—Å—Ç: –ø–æ–¥–∞—Ç—å —Å–∏–Ω—É—Å 48k, –ø–æ–ª—É—á–∏—Ç—å 8k, —Å–æ–±—Ä–∞—Ç—å/—Ä–∞–∑–æ–±—Ä–∞—Ç—å –ø–æ 20 –º—Å.

–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä —Å —Ç–æ—á–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏: 20 –º—Å ‚Üí 160 —Å—ç–º–ø–ª–æ–≤ ‚Üí 320 –±–∞–π—Ç.

‚∏ª

–ó–∞–¥–∞—á–∞ 4. VAD (Sierra + fallback) –∏ —Å–æ–±—ã—Ç–∏—è

–¶–µ–ª—å: —á—ë—Ç–∫–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è –Ω–∞—á–∞–ª–∞/–∫–æ–Ω—Ü–∞ —Ä–µ—á–∏ + barge-in.
- vad.py —Å –µ–¥–∏–Ω—ã–º –∫–ª–∞—Å—Å–æ–º VoiceActivityDetector:
- backend "sierra" (–µ—Å–ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞) –∏ "webrtc" –∫–∞–∫ fallback;
- –º–µ—Ç–æ–¥—ã: is_speech(frame_20ms_8k_bytes) -> bool.
- –í pipeline.py: –±—É—Ñ–µ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏–π, –ø–æ—Ä–æ–≥–∏ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ —á–µ—Ä–µ–∑ config.py):
- speech_started: N –≥–æ–ª–æ—Å–æ–≤—ã—Ö –ø–æ–¥—Ä—è–¥ (6‚Äì8);
- speech_ended: M —Ç–∏—à–∏–Ω –ø–æ–¥—Ä—è–¥ (8‚Äì10).
- –ì–µ–Ω–µ—Ä–∏—Ç—å —Å–æ–±—ã—Ç–∏—è –≤ –º–æ–∫-–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä: on_speech_started, on_speech_ended(...).

–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: –≤ –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ begin/end —Ä–µ—á–∏ —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –º–µ—Ç–∫–∞–º–∏.

‚∏ª

–ó–∞–¥–∞—á–∞ 5. Barge-in

–¶–µ–ª—å: –≤–æ –≤—Ä–µ–º—è –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –±–æ—Ç–∞ ‚Äî –ø—Ä–µ—Ä—ã–≤–∞—Ç—å –ø–æ –Ω–æ–≤–æ–π —Ä–µ—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- –í pipeline.py —Ö—Ä–∞–Ω–∏—Ç—å —Ñ–ª–∞–≥ bot_playing –∏ handler –∞–∫—Ç–∏–≤–Ω–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.
- –ü—Ä–∏ speech_started –∏ bot_playing==True:
- –≤—ã–∑–≤–∞—Ç—å orchestrator_mock.stop_playback(trace_id);
- –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å publish (¬´bot_out¬ª);
- –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å barge_in=true, playback_cancelled=true.

–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: —Ä—É–∫–∞–º–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º: –Ω–∞—á–∏–Ω–∞–µ–º –≥–æ–≤–æ—Ä–∏—Ç—å ‚Äî –±–æ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∑–∞—Ç—ã–∫–∞–µ—Ç—Å—è.

‚∏ª

–ó–∞–¥–∞—á–∞ 6. –ú–æ–∫-–û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –∏ –ø–æ—Ç–æ–∫ –æ—Ç–≤–µ—Ç–∞

–¶–µ–ª—å: —Å–≤—è–∑–∞—Ç—å –∫–æ–Ω–µ—Ü —Ä–µ—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–æ–ª—É—á–µ–Ω–∏–µ–º –∞—É–¥–∏–æ-–æ—Ç–≤–µ—Ç–∞ (—ç—Ö–æ).
- –ü–æ–¥–∫–ª—é—á–∏—Ç—å orchestrator_mock.py –≤ pipeline.py.
- –ù–∞ on_speech_ended:
- —Ñ–∏–∫—Å–∏—Ä—É–µ–º t2;
- –≤—ã–∑—ã–≤–∞–µ–º get_audio_reply (—Ñ–∏–∫—Å–∏—Ä—É–µ–º t3 –≤ –º–æ–º–µ–Ω—Ç –≤—ã–∑–æ–≤–∞);
- –Ω–∞ –ø–µ—Ä–≤–æ–º –≤—ã—Ö–æ–¥–Ω–æ–º —á–∞–Ω–∫–µ ‚Äî –∫–æ–ª–±—ç–∫ on_tts_first_chunk ‚Üí t5;
- –ø—É–±–ª–∏–∫—É–µ–º –ø–æ—Ç–æ–∫ –≤ LiveKit ‚Üí –ø–µ—Ä–≤—ã–π –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–π —á–∞–Ω–∫ = t6.
- –ú–µ—Ç—Ä–∏–∫–∏/–ª–æ–≥–∏ –ø–∏—Å–∞—Ç—å –≤ metrics.jsonl.

–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: —Å–ª—ã—à–∏–º –∫–æ—Ä–æ—Ç–∫–∏–π ¬´–±–∏–ø¬ª –∏ —Ç–∏—Ö—É—é –¥–æ—Ä–æ–∂–∫—É ¬´—ç—Ö–∞¬ª.

‚∏ª

–ó–∞–¥–∞—á–∞ 7. –ö–ª–∏–µ–Ω—Ç –∏ smoke-–ø—Ä–æ–≤–µ—Ä–∫–∏

–¶–µ–ª—å: –ø—Ä–æ—Å—Ç–∞—è –±—Ä–∞—É–∑–µ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∂–∏–≤—å—ë–º.

- –û—Ç–∫—Ä—ã—Ç—å client.html, –≤—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω, Join.
- –ü—Ä–æ–∏–∑–Ω–µ—Å–∏ ¬´–†–∞–∑-–¥–≤–∞-—Ç—Ä–∏¬ª ‚Üí –±–æ—Ç –æ—Ç–≤–µ—Ç–∏–ª; –Ω–∞—á–Ω–∏ –≥–æ–≤–æ—Ä–∏—Ç—å –≤ –º–æ–º–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∞ ‚Üí barge-in.
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∞–π–ª metrics.jsonl: –ø–æ–ª—è t1..t6, latency.

–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: –¥–µ–º–æ ¬´–≥–æ–≤–æ—Ä—é/–ø–µ—Ä–µ–±–∏–≤–∞—é/—Å–ª—ã—à—É¬ª —Å—Ç–∞–±–∏–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç.

‚∏ª

üìè –ß—Ç–æ –º–µ—Ä–∏–º (–º–∏–Ω–∏–º—É–º)
- latency_user_to_first_bot_chunk_ms = t6 - t1 ‚Äî —Ü–µ–ª–µ–≤–∞—è < 800 –º—Å (–æ—Ü–µ–Ω–∫–∞ –ø–æ –¥–µ–º–æ).
- vad_speech_ms ‚Äî –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–µ—á–∏ –ø–æ VAD.
- –ù–∞–ª–∏—á–∏–µ –∏ —á–∞—Å—Ç–æ—Ç–∞ barge_in.
- –í –ª–æ–≥–∞—Ö –≤–∏–¥–µ—Ç—å: start/stop playback, drop –ø–æ barge-in, –Ω–æ–º–µ—Ä–∞ —Ñ—Ä–µ–π–º–æ–≤, —Ä–∞–∑–º–µ—Ä—ã –±—É—Ñ–µ—Ä–æ–≤.

‚∏ª

üîå –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ —Ç–æ–Ω–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

config.py (–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ –¥–µ—Ñ–æ–ª—Ç–∞–º):

- AUDIO_TARGET_RATE = 8000
- AUDIO_FRAME_MS = 20
- VAD_BACKEND = "sierra" (fallback "webrtc")
- VAD_SPEECH_START_FRAMES = 6
- VAD_SPEECH_END_FRAMES = 10
- PUBLISH_TRACK_NAME = "bot_out"
- ROOM = os.environ["LK_ROOM"], IDENTITY = os.environ["LK_BOT_IDENTITY"]

–í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—ã–µ —á–µ—Ä–µ–∑ env.

‚∏ª

üßØ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –æ–≥–æ–≤–æ—Ä–∫–∏ (–Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –¥–µ–º–æ)
- –í –±—Ä–∞—É–∑–µ—Ä–µ LiveKit –≤—Å–µ–≥–¥–∞ –æ—Ç–¥–∞—ë—Ç Opus 48 –∫–ì—Ü. –ú—ã –≤–Ω—É—Ç—Ä–∏ –¥–µ—Ä–∂–∏–º 8 –∫–ì—Ü PCM, –∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–∞–∑–∞–¥ LiveKit –ø–µ—Ä–µ–∫–æ–¥–∏—Ä—É–µ—Ç –≤ Opus (48 –∫–ì—Ü). –≠—Ç–æ –æ–∫ –¥–ª—è –¥–µ–º–æ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –±—É–¥—É—â–∏–º–∏ STT/TTS.
- Sierra VAD: –µ—Å–ª–∏ –Ω–µ –≤–∑–ª–µ—Ç–∏—Ç ¬´–∏–∑ –∫–æ—Ä–æ–±–∫–∏¬ª, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å webrtcvad fallback (–æ–Ω –±—ã—Å—Ç—Ä—ã–π –∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π).
- –ù–∏–∫–∞–∫–∏—Ö —Å–ª–æ–∂–Ω—ã—Ö –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤/—Ä–µ–ø–ª–∏–∫–∞—Ü–∏–π: –æ–¥–Ω–∞ –∫–æ–º–Ω–∞—Ç–∞, –æ–¥–∏–Ω –±–æ—Ç.
- –ë–µ–∑ –≥–ª—É–±–æ–∫–∏—Ö –∞–≤—Ç–æ—Ç–µ—Å—Ç–æ–≤. –ù–∞–º –≤–∞–∂–Ω—ã —Ä—É—á–Ω—ã–µ smoke + JSON-–º–µ—Ç—Ä–∏–∫–∏.

‚∏ª

‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –¥–µ–º–æ
- –ö–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è, –≥–æ–≤–æ—Ä–∏—Ç ‚Äî —Å–ª—ã—à–∏—Ç –æ—Ç–≤–µ—Ç –æ—Ç –±–æ—Ç–∞.
- –ü—Ä–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ –ø–æ–≤–µ—Ä—Ö –æ—Ç–≤–µ—Ç–∞ ‚Üí –±–æ—Ç –∑–∞—Ç—ã–∫–∞–µ—Ç—Å—è (barge-in).
- –í metrics.jsonl –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–∏—à—É—Ç—Å—è t1..t6 –∏ —Å–≤–æ–¥–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏.
- –í voice_node.log –≤–∏–¥–Ω—ã –∫–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è (join, subscribe, publish, speech_started/ended, barge_in).

‚∏ª

–µ—Å–ª–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ Sierra VAD –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ –≤–∏–¥–µ –≥–æ—Ç–æ–≤–æ–≥–æ –ø–∏—Ç–æ–Ω-–ø–∞–∫–µ—Ç–∞ ‚Äî –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è: –≤–∫–ª—é—á–∞–µ–º webrtcvad –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π, –∞ Sierra –ø–æ–¥–≤–µ–∑—ë–º –ø–æ–∑–∂–µ —Ç–µ–º –∂–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º VoiceActivityDetector.
